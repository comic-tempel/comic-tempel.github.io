var $=Object.defineProperty;var T=Object.getOwnPropertySymbols;var O=Object.prototype.hasOwnProperty,P=Object.prototype.propertyIsEnumerable;var V=(a,l,i)=>l in a?$(a,l,{enumerable:!0,configurable:!0,writable:!0,value:i}):a[l]=i,U=(a,l)=>{for(var i in l||(l={}))O.call(l,i)&&V(a,i,l[i]);if(T)for(var i of T(l))P.call(l,i)&&V(a,i,l[i]);return a};import{a as R,c as A,u as S}from"./useMachine.da6d92a1.js";import{i as N}from"./index.1a1d4649.js";import{d as w,an as F,z as I,A as x,ab as H,o as C,k as L,p as j,a as o,w as u,u as e,ao as q,a6 as v,ap as _,aq as E,ar as Y,K as z,as as G,H as K,M as W,R as k,y as h,q as J,x as Q,c as y,B as X,D,ak as Z,E as ee,g as te,a3 as ne,G as se,at as ie,O as oe,h as le,i as ae}from"./index.44b7e4a8.js";import{u as ue}from"./mangas.bf17eaa3.js";import{a as B}from"./ui.ed3226fb.js";var re=R;const de={class:"p-4"},ce=k("Wenn ein bestimmtes Attribut aktualisiert werden soll, musst Du das H\xE4ckchen auf der rechten Seite aktivieren."),pe=k("f\xFCr alle sichtbar"),be=w({props:{currentTitle:null,currentSubtitle:null,currentDescription:null,isCurrentlyVisible:{type:Boolean},focus:null},emits:["update","empty"],setup(a,{emit:l}){var m,g,c;const i=a,s=F({title:{value:i.currentTitle,isUpdate:i.focus==="title"},subtitle:{value:(m=i.currentSubtitle)!=null?m:"",isUpdate:i.focus==="subtitle"},description:{value:(g=i.currentDescription)!=null?g:"",isUpdate:i.focus==="description"},is_visible:{value:(c=i.isCurrentlyVisible)!=null?c:!0,isUpdate:!1}}),d=I(null),b=I(null),f=I(null);return x(()=>{const r=n=>setTimeout(()=>n==null?void 0:n.$el.setFocus(),300);switch(i.focus){case"title":r(d.value);case"subtitle":r(b.value);case"description":r(f.value);default:return}}),H(s,r=>{const n=Object.entries(r).filter(t=>t[1].isUpdate).map(t=>({[t[0]]:t[1].value})).reduce((t,p)=>U(U({},t),p),{});Object.keys(n).length>0?l("update",{contribution:n}):l("empty")},{deep:!0}),(r,n)=>(C(),L(W,null,[j("div",de,[o(e(q),null,{default:u(()=>[ce]),_:1})]),o(e(K),{lines:"full"},{default:u(()=>[o(e(v),null,{default:u(()=>[o(e(_),{ref_key:"titleInput",ref:d,placeholder:"Titel",modelValue:e(s).title.value,"onUpdate:modelValue":n[0]||(n[0]=t=>e(s).title.value=t),disabled:!e(s).title.isUpdate,onClick:n[1]||(n[1]=t=>e(s).title.isUpdate=!0)},null,8,["modelValue","disabled"]),o(e(E),{modelValue:e(s).title.isUpdate,"onUpdate:modelValue":n[2]||(n[2]=t=>e(s).title.isUpdate=t),slot:"end"},null,8,["modelValue"])]),_:1}),o(e(v),null,{default:u(()=>[o(e(_),{ref_key:"subtitleInput",ref:b,placeholder:"Untertitel",modelValue:e(s).subtitle.value,"onUpdate:modelValue":n[3]||(n[3]=t=>e(s).subtitle.value=t),disabled:!e(s).subtitle.isUpdate,onClick:n[4]||(n[4]=t=>e(s).subtitle.isUpdate=!0)},null,8,["modelValue","disabled"]),o(e(E),{modelValue:e(s).subtitle.isUpdate,"onUpdate:modelValue":n[5]||(n[5]=t=>e(s).subtitle.isUpdate=t),slot:"end"},null,8,["modelValue"])]),_:1}),o(e(v),null,{default:u(()=>[o(e(Y),{ref_key:"descriptionInput",ref:f,placeholder:"Beschreibung",modelValue:e(s).description.value,"onUpdate:modelValue":n[6]||(n[6]=t=>e(s).description.value=t),disabled:!e(s).description.isUpdate,"auto-grow":!0,onClick:n[7]||(n[7]=t=>e(s).description.isUpdate=!0)},null,8,["modelValue","disabled"]),o(e(E),{modelValue:e(s).description.isUpdate,"onUpdate:modelValue":n[8]||(n[8]=t=>e(s).description.isUpdate=t),slot:"end"},null,8,["modelValue"])]),_:1}),o(e(v),{lines:"none"},{default:u(()=>[o(e(z),null,{default:u(()=>[pe]),_:1}),o(e(G),{modelValue:e(s).is_visible.value,"onUpdate:modelValue":n[9]||(n[9]=t=>e(s).is_visible.value=t),slot:"end",onIonChange:n[10]||(n[10]=t=>e(s).is_visible.isUpdate=e(s).is_visible.value!==a.isCurrentlyVisible)},null,8,["modelValue"])]),_:1})]),_:1})],64))}}),{currentUser:fe}=h(),{client:M}=J(),me=async(a,l)=>{var d;const{error:i,data:s}=await M.rpc("contribution_event_creation",{_data:l,_creator_id:(d=fe.value)==null?void 0:d.id,_gtin13:a}).single();if(i!=null||s<1)throw console.error(i!=null?i:"unknown Error"),Error();return s},ge=async(a,l)=>{const{error:i}=await M.rpc("contributions_update",{_gtin13:a,_target_version:l});if(i!=null)throw console.error(i!=null?i:"unknown Error"),Error()},ve=()=>({createContribution:me,updateContributions:ge}),Ue=k("Manga bearbeiten"),_e=w({props:{gtin13:null,focus:null},setup(a){const l=a,{load:i,manga:s}=ue(),{createContribution:d,updateContributions:b}=ve(),{back:f}=Q(),{hasPermission:m}=h(),g=A({id:"MangaEditor",initial:"Untouched",on:{EDITOR_UPDATE:{actions:"updateContribution"}},states:{Untouched:{on:{EDITOR_UPDATE:{target:"Editing",actions:"updateContribution"}}},Editing:{on:{EDITOR_EMPTY:{target:"Untouched"},SUBMIT:{target:"Contributing"}}},Contributing:{invoke:{id:"createContribution",src:"createContribution",onDone:{actions:["toastSuccess","leaveEditor"]},onError:{target:"Editing",actions:"toastError"}}}}},{actions:{updateContribution:re({contribution:(n,t)=>t.type=="EDITOR_UPDATE"?t.contribution:n.contribution}),toastSuccess:()=>B({message:"Dein Beitrag ist in sp\xE4testens 5 Minuten online.",color:"success"}),toastError:()=>B({message:"Ups, da ist etwas schiefgegangen. Bitte versuch es sp\xE4ter erneut."}),leaveEditor:()=>f()},services:{createContribution:async n=>{const t=await d(l.gtin13,n.contribution);m("contributions.update")&&await b(l.gtin13,t)}}}),{state:c,send:r}=S(g,{devTools:!1});return x(()=>i(l.gtin13)),(n,t)=>(C(),y(e(ae),null,{default:u(()=>[o(e(se),{class:"ion-no-border",translucent:!0},{default:u(()=>[o(e(X),null,{default:u(()=>[o(e(D),{slot:"start"},{default:u(()=>[o(e(Z),{disabled:e(c).matches("Contributing"),"default-href":"/",text:""},null,8,["disabled"])]),_:1}),o(e(D),{slot:"end"},{default:u(()=>[o(e(ee),{onClick:t[0]||(t[0]=p=>e(r)("SUBMIT")),disabled:!e(c).matches("Editing")},{default:u(()=>[o(e(te),{slot:"icon-only",src:e(N)},null,8,["src"])]),_:1},8,["disabled"])]),_:1}),o(e(ne),null,{default:u(()=>[Ue]),_:1})]),_:1})]),_:1}),o(e(le),{class:"ion-padding",fullscreen:!0},{default:u(()=>[o(e(ie),{"is-open":e(c).matches("Contributing"),message:"Ich speichere Deinen Beitrag..."},null,8,["is-open"]),e(s)?(C(),y(be,{key:0,"current-title":e(s).title,"current-subtitle":e(s).subtitle,"current-description":e(s).description,"is-currently-visible":e(s).is_visible,focus:a.focus,onUpdate:t[1]||(t[1]=p=>e(r)("EDITOR_UPDATE",p)),onEmpty:t[2]||(t[2]=p=>e(r)("EDITOR_EMPTY"))},null,8,["current-title","current-subtitle","current-description","is-currently-visible","focus"])):oe("",!0)]),_:1})]),_:1}))}});export{_e as default};
