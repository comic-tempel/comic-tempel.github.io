var M=Object.defineProperty;var T=Object.getOwnPropertySymbols;var P=Object.prototype.hasOwnProperty,$=Object.prototype.propertyIsEnumerable;var C=(l,i,e)=>i in l?M(l,i,{enumerable:!0,configurable:!0,writable:!0,value:e}):l[i]=e,I=(l,i)=>{for(var e in i||(i={}))P.call(i,e)&&C(l,e,i[e]);if(T)for(var e of T(i))$.call(i,e)&&C(l,e,i[e]);return l};import{a as O,c as A,u as R}from"./useMachine.a3daba43.js";import{f as S}from"./index.50a34d4d.js";import{d as w,ae as N,r as U,P as B,a0 as j,o as k,x as F,K as H,a,w as r,u as t,af as L,a8 as v,ag as _,ah as E,ai as Y,s as q,F as z,z as h,k as y,A as K,j as W,c as V,l as G,m as D,a7 as J,n as Q,g as X,p as Z,q as tt,aj as et,H as nt,h as st,i as ot}from"./index.50226f6b.js";import{u as it}from"./mangas.88b6856b.js";import{a as at}from"./ui.c9a22d70.js";var lt=O;const ut={class:"p-4"},rt=h("Wenn ein bestimmtes Attribut aktualisiert werden soll, musst Du das H\xE4ckchen auf der rechten Seite aktivieren."),dt=w({props:{currentTitle:null,currentSubtitle:null,currentDescription:null,focus:null},emits:["update","empty"],setup(l,{emit:i}){var f,m;const e=l,s=N({title:{value:e.currentTitle,isUpdate:e.focus==="title"},subtitle:{value:(f=e.currentSubtitle)!=null?f:"",isUpdate:e.focus==="subtitle"},description:{value:(m=e.currentDescription)!=null?m:"",isUpdate:e.focus==="description"}}),c=U(null),p=U(null),b=U(null);return B(()=>{const d=n=>setTimeout(()=>n==null?void 0:n.$el.setFocus(),300);switch(e.focus){case"title":d(c.value);case"subtitle":d(p.value);case"description":d(b.value);default:return}}),j(s,d=>{const n=Object.entries(d).filter(o=>o[1].isUpdate).map(o=>({[o[0]]:o[1].value})).reduce((o,u)=>I(I({},o),u),{});Object.keys(n).length>0?i("update",{contribution:n}):i("empty")},{deep:!0}),(d,n)=>(k(),F(z,null,[H("div",ut,[a(t(L),null,{default:r(()=>[rt]),_:1})]),a(t(q),null,{default:r(()=>[a(t(v),null,{default:r(()=>[a(t(_),{ref_key:"titleInput",ref:c,placeholder:"Titel",modelValue:t(s).title.value,"onUpdate:modelValue":n[0]||(n[0]=o=>t(s).title.value=o),disabled:!t(s).title.isUpdate,onClick:n[1]||(n[1]=o=>t(s).title.isUpdate=!0)},null,8,["modelValue","disabled"]),a(t(E),{modelValue:t(s).title.isUpdate,"onUpdate:modelValue":n[2]||(n[2]=o=>t(s).title.isUpdate=o),slot:"end"},null,8,["modelValue"])]),_:1}),a(t(v),null,{default:r(()=>[a(t(_),{ref_key:"subtitleInput",ref:p,placeholder:"Untertitel",modelValue:t(s).subtitle.value,"onUpdate:modelValue":n[3]||(n[3]=o=>t(s).subtitle.value=o),disabled:!t(s).subtitle.isUpdate,onClick:n[4]||(n[4]=o=>t(s).subtitle.isUpdate=!0)},null,8,["modelValue","disabled"]),a(t(E),{modelValue:t(s).subtitle.isUpdate,"onUpdate:modelValue":n[5]||(n[5]=o=>t(s).subtitle.isUpdate=o),slot:"end"},null,8,["modelValue"])]),_:1}),a(t(v),null,{default:r(()=>[a(t(Y),{ref_key:"descriptionInput",ref:b,placeholder:"Beschreibung",modelValue:t(s).description.value,"onUpdate:modelValue":n[6]||(n[6]=o=>t(s).description.value=o),disabled:!t(s).description.isUpdate,"auto-grow":!0,onClick:n[7]||(n[7]=o=>t(s).description.isUpdate=!0)},null,8,["modelValue","disabled"]),a(t(E),{modelValue:t(s).description.isUpdate,"onUpdate:modelValue":n[8]||(n[8]=o=>t(s).description.isUpdate=o),slot:"end"},null,8,["modelValue"])]),_:1})]),_:1})],64))}}),{currentUser:ct}=y(),{client:x}=K(),pt=async(l,i)=>{var c;const{error:e,data:s}=await x.rpc("contribution_event_creation",{_data:i,_creator_id:(c=ct.value)==null?void 0:c.id,_gtin13:l}).single();if(e!=null||s<1)throw console.error(e!=null?e:"unknown Error"),Error();return s},bt=async(l,i)=>{const{error:e}=await x.rpc("contributions_update",{_gtin13:l,_target_version:i});if(e!=null)throw console.error(e!=null?e:"unknown Error"),Error()},ft=()=>({createContribution:pt,updateContributions:bt}),mt=h("Manga bearbeiten"),Tt=w({props:{gtin13:null,focus:null},setup(l){const i=l,{load:e,manga:s}=it(),{createContribution:c,updateContributions:p}=ft(),{back:b}=W(),{hasPermission:f}=y(),m=A({id:"MangaEditor",initial:"Untouched",on:{EDITOR_UPDATE:{actions:"updateContribution"}},states:{Untouched:{on:{EDITOR_UPDATE:{target:"Editing"}}},Editing:{on:{EDITOR_EMPTY:{target:"Untouched"},SUBMIT:{target:"Contributing"}}},Contributing:{invoke:{id:"createContribution",src:"createContribution",onDone:{actions:["toastSuccess","leaveEditor"]},onError:{target:"Editing",actions:"toastError"}}}}},{actions:{updateContribution:lt({contribution:(o,u)=>u.type=="EDITOR_UPDATE"?u.contribution:o.contribution}),toastSuccess:()=>at({message:"Dein Beitrag ist in sp\xE4testens 5 Minuten online.",color:"success"}),leaveEditor:()=>b()},services:{createContribution:async o=>{const u=await c(i.gtin13,o.contribution);f("contributions.update")&&await p(i.gtin13,u)}}}),{state:d,send:n}=R(m,{devTools:!1});return B(()=>e(i.gtin13)),(o,u)=>(k(),V(t(ot),null,{default:r(()=>[a(t(tt),{class:"ion-no-border",translucent:!0},{default:r(()=>[a(t(G),null,{default:r(()=>[a(t(D),{slot:"start"},{default:r(()=>[a(t(J),{disabled:t(d).matches("Contributing"),"default-href":"/",text:""},null,8,["disabled"])]),_:1}),a(t(D),{slot:"end"},{default:r(()=>[a(t(Q),{onClick:u[0]||(u[0]=g=>t(n)("SUBMIT")),disabled:!t(d).matches("Editing")},{default:r(()=>[a(t(X),{slot:"icon-only",src:t(S)},null,8,["src"])]),_:1},8,["disabled"])]),_:1}),a(t(Z),null,{default:r(()=>[mt]),_:1})]),_:1})]),_:1}),a(t(st),{class:"ion-padding",fullscreen:!0},{default:r(()=>[a(t(et),{"is-open":t(d).matches("Contributing"),message:"Ich speichere Deinen Beitrag..."},null,8,["is-open"]),t(s)?(k(),V(dt,{key:0,"current-title":t(s).title,"current-subtitle":t(s).subtitle,"current-description":t(s).description,focus:l.focus,onUpdate:u[1]||(u[1]=g=>t(n)("EDITOR_UPDATE",g)),onEmpty:u[2]||(u[2]=g=>t(n)("EDITOR_EMPTY"))},null,8,["current-title","current-subtitle","current-description","focus"])):nt("",!0)]),_:1})]),_:1}))}});export{Tt as default};
