var h=Object.defineProperty;var T=Object.getOwnPropertySymbols;var $=Object.prototype.hasOwnProperty,O=Object.prototype.propertyIsEnumerable;var V=(l,a,i)=>a in l?h(l,a,{enumerable:!0,configurable:!0,writable:!0,value:i}):l[a]=i,v=(l,a)=>{for(var i in a||(a={}))$.call(a,i)&&V(l,i,a[i]);if(T)for(var i of T(a))O.call(a,i)&&V(l,i,a[i]);return l};import{a as A,c as R,u as S}from"./useMachine.c8999c58.js";import{i as N}from"./index.1a1d4649.js";import{d as w,an as F,z as I,A as x,ab as L,k as H,l as j,a as o,w as u,u as e,N as q,o as C,L as k,ao as Y,a6 as U,ap as _,aq as E,ar as z,K as G,as as K,H as W,y as M,q as J,x as Q,c as y,B as X,D,ak as Z,E as ee,g as te,a3 as ne,G as se,at as ie,P as oe,h as ae,i as le}from"./index.10d7ba67.js";import{u as ue}from"./mangas.cddc7dbb.js";import{a as B}from"./ui.be55ac54.js";var re=A;const de={class:"p-4"},ce=w({__name:"MangaEditorForm",props:{currentTitle:null,currentSubtitle:null,currentDescription:null,isCurrentlyVisible:{type:Boolean},focus:null},emits:["update","empty"],setup(l,{emit:a}){var f,g,p;const i=l,s=F({title:{value:i.currentTitle,isUpdate:i.focus==="title"},subtitle:{value:(f=i.currentSubtitle)!=null?f:"",isUpdate:i.focus==="subtitle"},description:{value:(g=i.currentDescription)!=null?g:"",isUpdate:i.focus==="description"},is_visible:{value:(p=i.isCurrentlyVisible)!=null?p:!0,isUpdate:!1}}),d=I(null),c=I(null),m=I(null);return x(()=>{const r=n=>setTimeout(()=>n==null?void 0:n.$el.setFocus(),300);switch(i.focus){case"title":r(d.value);case"subtitle":r(c.value);case"description":r(m.value);default:return}}),L(s,r=>{const n=Object.entries(r).filter(t=>t[1].isUpdate).map(t=>({[t[0]]:t[1].value})).reduce((t,b)=>v(v({},t),b),{});Object.keys(n).length>0?a("update",{contribution:n}):a("empty")},{deep:!0}),(r,n)=>(C(),H(q,null,[j("div",de,[o(e(Y),null,{default:u(()=>[k("Wenn ein bestimmtes Attribut aktualisiert werden soll, musst Du das H\xE4ckchen auf der rechten Seite aktivieren.")]),_:1})]),o(e(W),{lines:"full"},{default:u(()=>[o(e(U),null,{default:u(()=>[o(e(_),{ref_key:"titleInput",ref:d,placeholder:"Titel",modelValue:s.title.value,"onUpdate:modelValue":n[0]||(n[0]=t=>s.title.value=t),disabled:!s.title.isUpdate,onClick:n[1]||(n[1]=t=>s.title.isUpdate=!0)},null,8,["modelValue","disabled"]),o(e(E),{modelValue:s.title.isUpdate,"onUpdate:modelValue":n[2]||(n[2]=t=>s.title.isUpdate=t),slot:"end"},null,8,["modelValue"])]),_:1}),o(e(U),null,{default:u(()=>[o(e(_),{ref_key:"subtitleInput",ref:c,placeholder:"Untertitel",modelValue:s.subtitle.value,"onUpdate:modelValue":n[3]||(n[3]=t=>s.subtitle.value=t),disabled:!s.subtitle.isUpdate,onClick:n[4]||(n[4]=t=>s.subtitle.isUpdate=!0)},null,8,["modelValue","disabled"]),o(e(E),{modelValue:s.subtitle.isUpdate,"onUpdate:modelValue":n[5]||(n[5]=t=>s.subtitle.isUpdate=t),slot:"end"},null,8,["modelValue"])]),_:1}),o(e(U),null,{default:u(()=>[o(e(z),{ref_key:"descriptionInput",ref:m,placeholder:"Beschreibung",modelValue:s.description.value,"onUpdate:modelValue":n[6]||(n[6]=t=>s.description.value=t),disabled:!s.description.isUpdate,"auto-grow":!0,onClick:n[7]||(n[7]=t=>s.description.isUpdate=!0)},null,8,["modelValue","disabled"]),o(e(E),{modelValue:s.description.isUpdate,"onUpdate:modelValue":n[8]||(n[8]=t=>s.description.isUpdate=t),slot:"end"},null,8,["modelValue"])]),_:1}),o(e(U),{lines:"none"},{default:u(()=>[o(e(G),null,{default:u(()=>[k("f\xFCr alle sichtbar")]),_:1}),o(e(K),{modelValue:s.is_visible.value,"onUpdate:modelValue":n[9]||(n[9]=t=>s.is_visible.value=t),slot:"end",onIonChange:n[10]||(n[10]=t=>s.is_visible.isUpdate=s.is_visible.value!==l.isCurrentlyVisible)},null,8,["modelValue"])]),_:1})]),_:1})],64))}}),{currentUser:pe}=M(),{client:P}=J(),be=async(l,a)=>{var d,c;const{error:i,data:s}=await P.rpc("contribution_event_creation",{_data:v({},a),_creator_id:(c=(d=pe.value)==null?void 0:d.id)!=null?c:"",_gtin13:l}).single();if(i!=null||s<1)throw console.error(i!=null?i:"unknown Error"),Error();return s},me=async(l,a)=>{const{error:i}=await P.rpc("contributions_update",{_gtin13:l,_target_version:a});if(i!=null)throw console.error(i!=null?i:"unknown Error"),Error()},fe=()=>({createContribution:be,updateContributions:me}),ke=w({__name:"MangaEditorPage",props:{gtin13:null,focus:null},setup(l){const a=l,{load:i,manga:s}=ue(),{createContribution:d,updateContributions:c}=fe(),{back:m}=Q(),{hasPermission:f}=M(),g=R({id:"MangaEditor",initial:"Untouched",on:{EDITOR_UPDATE:{actions:"updateContribution"}},states:{Untouched:{on:{EDITOR_UPDATE:{target:"Editing",actions:"updateContribution"}}},Editing:{on:{EDITOR_EMPTY:{target:"Untouched"},SUBMIT:{target:"Contributing"}}},Contributing:{invoke:{id:"createContribution",src:"createContribution",onDone:{actions:["toastSuccess","leaveEditor"]},onError:{target:"Editing",actions:"toastError"}}}}},{actions:{updateContribution:re({contribution:(n,t)=>t.type=="EDITOR_UPDATE"?t.contribution:n.contribution}),toastSuccess:()=>B({message:"Dein Beitrag ist in sp\xE4testens 5 Minuten online.",color:"success"}),toastError:()=>B({message:"Ups, da ist etwas schiefgegangen. Bitte versuch es sp\xE4ter erneut."}),leaveEditor:()=>m()},services:{createContribution:async n=>{const t=await d(a.gtin13,n.contribution);f("contributions.update")&&await c(a.gtin13,t)}}}),{state:p,send:r}=S(g,{devTools:!1});return x(()=>i(a.gtin13)),(n,t)=>(C(),y(e(le),null,{default:u(()=>[o(e(se),{translucent:!0},{default:u(()=>[o(e(X),null,{default:u(()=>[o(e(D),{slot:"start"},{default:u(()=>[o(e(Z),{disabled:e(p).matches("Contributing"),"default-href":"/",text:""},null,8,["disabled"])]),_:1}),o(e(D),{slot:"end"},{default:u(()=>[o(e(ee),{onClick:t[0]||(t[0]=b=>e(r)("SUBMIT")),disabled:!e(p).matches("Editing")},{default:u(()=>[o(e(te),{slot:"icon-only",src:e(N)},null,8,["src"])]),_:1},8,["disabled"])]),_:1}),o(e(ne),null,{default:u(()=>[k("Manga bearbeiten")]),_:1})]),_:1})]),_:1}),o(e(ae),{class:"ion-padding",fullscreen:!0},{default:u(()=>[o(e(ie),{"is-open":e(p).matches("Contributing"),message:"Ich speichere Deinen Beitrag..."},null,8,["is-open"]),e(s)?(C(),y(ce,{key:0,"current-title":e(s).title,"current-subtitle":e(s).subtitle,"current-description":e(s).description,"is-currently-visible":e(s).is_visible,focus:l.focus,onUpdate:t[1]||(t[1]=b=>e(r)("EDITOR_UPDATE",b)),onEmpty:t[2]||(t[2]=b=>e(r)("EDITOR_EMPTY"))},null,8,["current-title","current-subtitle","current-description","is-currently-visible","focus"])):oe("",!0)]),_:1})]),_:1}))}});export{ke as default};
