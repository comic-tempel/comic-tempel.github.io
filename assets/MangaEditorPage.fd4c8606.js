var X=Object.defineProperty;var A=Object.getOwnPropertySymbols;var Z=Object.prototype.hasOwnProperty,ee=Object.prototype.propertyIsEnumerable;var N=(r,s,n)=>s in r?X(r,s,{enumerable:!0,configurable:!0,writable:!0,value:n}):r[s]=n,$=(r,s)=>{for(var n in s||(s={}))Z.call(s,n)&&N(r,n,s[n]);if(A)for(var n of A(s))ee.call(s,n)&&N(r,n,s[n]);return r};import{a as te,c as le,u as ne}from"./useMachine.53b60af2.js";import{t as oe,i as ie}from"./index.2d43f867.js";import{d as P,z as y,y as h,o as f,c as V,w as a,a as o,u as e,G as H,B as L,C as ae,D as w,E as B,g as j,H as z,k as T,N as D,l as q,L as C,P as W,O as se,a6 as E,p as re,n as ue,K as G,t as K,h as Q,an as ce,A as M,ab as de,ao as pe,ap as R,aq as x,F as me,V as fe,ar as be,as as _e,q as ve,x as ge,ak as ke,a3 as Ce,at as Ue,i as Ie}from"./index.4480e0c3.js";import{_ as Ee,a as ye}from"./WikiImg.1a8e85d9.js";import{u as Ve}from"./collections.a9ca7c53.js";import{_ as Te}from"./CenteredMessage.af6d3478.js";import{d as De}from"./dayjs.min.3318dc7e.js";import{_ as $e}from"./plugin-vue_export-helper.21dcd24c.js";import{u as xe}from"./mangas.549edce8.js";import{a as Y}from"./ui.5d611d42.js";var Be=te;const we={class:"grid place-items-center pt-2"},Me=P({__name:"CollectionPicker",emits:["focused","pick","clear"],setup(r,{emit:s}){const n=y(""),{collections:t}=Ve(n),{hasPermission:b}=h(),_=v=>s("pick",v),U=()=>{s("pick",{collection_id:`MWC${De().format("YYYYMMDDHHmmss")}`,collection_name:n.value.trim(),cover:null})};return(v,m)=>(f(),V(e(Q),{class:"ion-padding"},{default:a(()=>[o(e(H),{class:"ion-no-border"},{default:a(()=>[o(e(L),null,{default:a(()=>[o(e(ae),{placeholder:"Serie suchen",modelValue:n.value,"onUpdate:modelValue":m[0]||(m[0]=u=>n.value=u),debounce:500,onClick:m[1]||(m[1]=u=>s("focused"))},null,8,["modelValue"]),o(e(w),{slot:"end"},{default:a(()=>[o(e(B),{onClick:m[2]||(m[2]=u=>s("clear"))},{default:a(()=>[o(e(j),{slot:"icon-only",src:e(oe)},null,8,["src"])]),_:1})]),_:1})]),_:1})]),_:1}),o(e(z),null,{default:a(()=>[e(t).length<1?(f(),T(D,{key:0},[o(Te,{class:"pt-8",emoji:"\u{1F914}",text:"Serie nicht gefunden"}),q("div",we,[e(b)("contribution.add_collection")?(f(),V(e(B),{key:0,class:"text-center",disabled:n.value.length<2,onClick:U},{default:a(()=>[C("anlegen")]),_:1},8,["disabled"])):W("",!0)])],64)):(f(!0),T(D,{key:1},se(e(t),u=>{var g;return f(),V(e(E),{key:(g=u.collection_id)!=null?g:"",button:!0,onClick:p=>_(u)},{default:a(()=>[o(e(re),{slot:"start"},{default:a(()=>{var p;return[o(Ee,{src:(p=u.cover)!=null?p:""},{default:a(()=>[o(e(ue),{class:"opacity-30",src:e(ye)},null,8,["src"])]),_:2},1032,["src"])]}),_:2},1024),o(e(G),null,{default:a(()=>[C(K(u.collection_name),1)]),_:2},1024)]),_:2},1032,["onClick"])}),128))]),_:1})]),_:1}))}});const Pe={class:"p-4"},he=P({__name:"MangaEditorForm",props:{currentTitle:null,currentSubtitle:null,currentDescription:null,isCurrentlyVisible:{type:Boolean},currentCollectionId:null,currentCollectionName:null,focus:null},emits:["update","empty"],setup(r,{emit:s}){var p,c,I,S,F;const n=r,t=ce({title:{value:n.currentTitle,isUpdate:n.focus==="title"},subtitle:{value:(p=n.currentSubtitle)!=null?p:"",isUpdate:n.focus==="subtitle"},description:{value:(c=n.currentDescription)!=null?c:"",isUpdate:n.focus==="description"},is_visible:{value:(I=n.isCurrentlyVisible)!=null?I:!0,isUpdate:!1},collection_id:{value:(S=n.currentCollectionId)!=null?S:null,isUpdate:!1},collection_name:{value:(F=n.currentCollectionName)!=null?F:null,isUpdate:!1}}),b=y(null),_=y(null),U=y(null),v=y(null),m=d=>{var l;(l=v.value)==null||l.$el.dismiss(d,"picked")},u=()=>{var d;(d=v.value)==null||d.$el.dismiss(void 0,"cleared")},g=d=>{var k,O;const l=d.detail.data,i=d.detail.role;i=="picked"?(t.collection_name.isUpdate=(l==null?void 0:l.collection_id)!=n.currentCollectionId,t.collection_id.value=(k=l==null?void 0:l.collection_id)!=null?k:null,t.collection_name.value=(O=l==null?void 0:l.collection_name)!=null?O:null):i!=="cleared"&&!t.collection_name.value?t.collection_name.isUpdate=!1:i=="cleared"&&n.currentCollectionId!==null?(t.collection_id.value="",t.collection_name.value="",t.collection_id.isUpdate=!0,t.collection_name.isUpdate=!0):n.currentCollectionId===null&&(t.collection_id.value=null,t.collection_name.value=null,t.collection_id.isUpdate=!1,t.collection_name.isUpdate=!1)};return M(()=>t.collection_id.isUpdate=t.collection_name.isUpdate),M(()=>{const d=l=>setTimeout(()=>l==null?void 0:l.$el.setFocus(),300);switch(n.focus){case"title":d(b.value);case"subtitle":d(_.value);case"description":d(U.value);default:return}}),de(t,d=>{const l=Object.entries(d).filter(i=>i[1].isUpdate).filter(i=>i[1].value!=null).map(i=>({[i[0]]:i[1].value})).reduce((i,k)=>$($({},i),k),{});Object.keys(l).length>0?s("update",{contribution:l}):s("empty")},{deep:!0}),(d,l)=>(f(),T(D,null,[q("div",Pe,[o(e(pe),null,{default:a(()=>[C("Wenn ein bestimmtes Attribut aktualisiert werden soll, musst Du das H\xE4ckchen auf der rechten Seite aktivieren.")]),_:1})]),o(e(z),{lines:"full"},{default:a(()=>[o(e(E),null,{default:a(()=>[o(e(R),{ref_key:"titleInput",ref:b,placeholder:"Titel",modelValue:t.title.value,"onUpdate:modelValue":l[0]||(l[0]=i=>t.title.value=i),disabled:!t.title.isUpdate,onClick:l[1]||(l[1]=i=>t.title.isUpdate=!0)},null,8,["modelValue","disabled"]),o(e(x),{modelValue:t.title.isUpdate,"onUpdate:modelValue":l[2]||(l[2]=i=>t.title.isUpdate=i),slot:"end"},null,8,["modelValue"])]),_:1}),o(e(E),null,{default:a(()=>[o(e(R),{ref_key:"subtitleInput",ref:_,placeholder:"Untertitel",modelValue:t.subtitle.value,"onUpdate:modelValue":l[3]||(l[3]=i=>t.subtitle.value=i),disabled:!t.subtitle.isUpdate,onClick:l[4]||(l[4]=i=>t.subtitle.isUpdate=!0)},null,8,["modelValue","disabled"]),o(e(x),{modelValue:t.subtitle.isUpdate,"onUpdate:modelValue":l[5]||(l[5]=i=>t.subtitle.isUpdate=i),slot:"end"},null,8,["modelValue"])]),_:1}),o(e(E),{class:"item-with-button"},{default:a(()=>[o(e(B),{slot:"start",fill:"clear",size:"default",id:"open-collection-picker",class:me({"opacity-40":!t.collection_name.isUpdate})},{default:a(()=>[t.collection_name.value==""||t.collection_name.value==null?(f(),T(D,{key:0},[C("keine Serie")],64)):(f(),T(D,{key:1},[C(K(t.collection_name.value),1)],64))]),_:1},8,["class"]),o(e(x),{modelValue:t.collection_name.isUpdate,"onUpdate:modelValue":l[6]||(l[6]=i=>t.collection_name.isUpdate=i),slot:"end"},null,8,["modelValue"])]),_:1}),o(e(fe),{ref_key:"collectionPicker",ref:v,trigger:"open-collection-picker","initial-breakpoint":.25,breakpoints:[0,.25,.5,.75],onDidDismiss:g},{default:a(()=>[o(Me,{onPick:m,onClear:u,onFocused:l[7]||(l[7]=i=>{var k;return(k=v.value)==null?void 0:k.$el.setCurrentBreakpoint(.75)})})]),_:1},8,["initial-breakpoint","breakpoints"]),o(e(E),null,{default:a(()=>[o(e(be),{ref_key:"descriptionInput",ref:U,placeholder:"Beschreibung",modelValue:t.description.value,"onUpdate:modelValue":l[8]||(l[8]=i=>t.description.value=i),disabled:!t.description.isUpdate,"auto-grow":!0,onClick:l[9]||(l[9]=i=>t.description.isUpdate=!0)},null,8,["modelValue","disabled"]),o(e(x),{modelValue:t.description.isUpdate,"onUpdate:modelValue":l[10]||(l[10]=i=>t.description.isUpdate=i),slot:"end"},null,8,["modelValue"])]),_:1}),o(e(E),{lines:"none"},{default:a(()=>[o(e(G),null,{default:a(()=>[C("f\xFCr alle sichtbar")]),_:1}),o(e(_e),{modelValue:t.is_visible.value,"onUpdate:modelValue":l[11]||(l[11]=i=>t.is_visible.value=i),slot:"end",onIonChange:l[12]||(l[12]=i=>t.is_visible.isUpdate=t.is_visible.value!==r.isCurrentlyVisible)},null,8,["modelValue"])]),_:1})]),_:1})],64))}});var Se=$e(he,[["__scopeId","data-v-c15d3bb8"]]);const{currentUser:Fe}=h(),{client:J}=ve(),Oe=async(r,s)=>{var b,_;const{error:n,data:t}=await J.rpc("contribution_event_creation",{_data:$({},s),_creator_id:(_=(b=Fe.value)==null?void 0:b.id)!=null?_:"",_gtin13:r}).single();if(n!=null||t<1)throw console.error(n!=null?n:"unknown Error"),Error();return t},Ae=async(r,s)=>{const{error:n}=await J.rpc("contributions_update",{_gtin13:r,_target_version:s});if(n!=null)throw console.error(n!=null?n:"unknown Error"),Error()},Ne=()=>({createContribution:Oe,updateContributions:Ae}),Je=P({__name:"MangaEditorPage",props:{gtin13:null,focus:null},setup(r){const s=r,{load:n,manga:t}=xe(),{createContribution:b,updateContributions:_}=Ne(),{back:U}=ge(),{hasPermission:v}=h(),m=le({id:"MangaEditor",initial:"Untouched",on:{EDITOR_UPDATE:{actions:"updateContribution"}},states:{Untouched:{on:{EDITOR_UPDATE:{target:"Editing",actions:"updateContribution"}}},Editing:{on:{EDITOR_EMPTY:{target:"Untouched"},SUBMIT:{target:"Contributing"}}},Contributing:{invoke:{id:"createContribution",src:"createContribution",onDone:{actions:["toastSuccess","leaveEditor"]},onError:{target:"Editing",actions:"toastError"}}}}},{actions:{updateContribution:Be({contribution:(p,c)=>c.type=="EDITOR_UPDATE"?c.contribution:p.contribution}),toastSuccess:()=>Y({message:"Dein Beitrag ist in sp\xE4testens 5 Minuten online.",color:"success"}),toastError:()=>Y({message:"Ups, da ist etwas schiefgegangen. Bitte versuch es sp\xE4ter erneut."}),leaveEditor:()=>U()},services:{createContribution:async p=>{const c=await b(s.gtin13,p.contribution);v("contributions.update")&&await _(s.gtin13,c)}}}),{state:u,send:g}=ne(m,{devTools:!1});return M(()=>n(s.gtin13)),(p,c)=>(f(),V(e(Ie),null,{default:a(()=>[o(e(H),{translucent:!0},{default:a(()=>[o(e(L),null,{default:a(()=>[o(e(w),{slot:"start"},{default:a(()=>[o(e(ke),{disabled:e(u).matches("Contributing"),"default-href":"/",text:""},null,8,["disabled"])]),_:1}),o(e(w),{slot:"end"},{default:a(()=>[o(e(B),{onClick:c[0]||(c[0]=I=>e(g)("SUBMIT")),disabled:!e(u).matches("Editing")},{default:a(()=>[o(e(j),{slot:"icon-only",src:e(ie)},null,8,["src"])]),_:1},8,["disabled"])]),_:1}),o(e(Ce),null,{default:a(()=>[C("Manga bearbeiten")]),_:1})]),_:1})]),_:1}),o(e(Q),{class:"ion-padding",fullscreen:!0},{default:a(()=>[o(e(Ue),{"is-open":e(u).matches("Contributing"),message:"Ich speichere Deinen Beitrag..."},null,8,["is-open"]),e(t)?(f(),V(Se,{key:0,"current-title":e(t).title,"current-subtitle":e(t).subtitle,"current-description":e(t).description,"is-currently-visible":e(t).is_visible,"current-collection-id":e(t).collection_id,"current-collection-name":e(t).collection_name,focus:r.focus,onUpdate:c[1]||(c[1]=I=>e(g)("EDITOR_UPDATE",I)),onEmpty:c[2]||(c[2]=I=>e(g)("EDITOR_EMPTY"))},null,8,["current-title","current-subtitle","current-description","is-currently-visible","current-collection-id","current-collection-name","focus"])):W("",!0)]),_:1})]),_:1}))}});export{Je as default};
