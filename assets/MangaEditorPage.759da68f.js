var X=Object.defineProperty;var A=Object.getOwnPropertySymbols;var Z=Object.prototype.hasOwnProperty,ee=Object.prototype.propertyIsEnumerable;var N=(r,s,n)=>s in r?X(r,s,{enumerable:!0,configurable:!0,writable:!0,value:n}):r[s]=n,$=(r,s)=>{for(var n in s||(s={}))Z.call(s,n)&&N(r,n,s[n]);if(A)for(var n of A(s))ee.call(s,n)&&N(r,n,s[n]);return r};import{a as te,c as le,u as ne}from"./useMachine.e0bbcf9b.js";import{t as oe,i as ie}from"./index.2d43f867.js";import{d as M,z as y,y as S,o as f,c as V,w as a,a as o,u as e,G as j,B as z,C as ae,D as w,E as B,g as H,H as q,k as T,N as D,l as W,L as U,P as Y,O as se,a6 as E,p as re,n as ue,K as G,t as K,h as Q,an as ce,A as P,ab as de,ao as pe,ap as R,aq as x,F as me,V as fe,ar as _e,as as be,q as ve,x as ge,ak as ke,a3 as Ue,at as Ce,i as Ie}from"./index.18e73127.js";import{_ as Ee,a as ye}from"./WikiImg.42da671e.js";import{u as Ve}from"./collections.34507d6b.js";import{_ as Te}from"./CenteredMessage.d8f50027.js";import{d as De}from"./dayjs.min.32455a51.js";import{_ as $e}from"./plugin-vue_export-helper.21dcd24c.js";import{u as xe}from"./mangas.398d39ba.js";import{a as L}from"./ui.c9bf80f1.js";var Be=te;const we={class:"grid place-items-center pt-2"},Pe=M({__name:"CollectionPicker",emits:["focused","pick","clear"],setup(r,{emit:s}){const n=y(""),{collections:t}=Ve(n),{hasPermission:_}=S(),b=v=>s("pick",v),C=()=>{s("pick",{collection_id:`MW-${De().toISOString()}`,collection_name:n.value.trim(),cover:null})};return(v,m)=>(f(),V(e(Q),{class:"ion-padding"},{default:a(()=>[o(e(j),{class:"ion-no-border"},{default:a(()=>[o(e(z),null,{default:a(()=>[o(e(ae),{placeholder:"Serie suchen",modelValue:n.value,"onUpdate:modelValue":m[0]||(m[0]=u=>n.value=u),debounce:500,onClick:m[1]||(m[1]=u=>s("focused"))},null,8,["modelValue"]),o(e(w),{slot:"end"},{default:a(()=>[o(e(B),{onClick:m[2]||(m[2]=u=>s("clear"))},{default:a(()=>[o(e(H),{slot:"icon-only",src:e(oe)},null,8,["src"])]),_:1})]),_:1})]),_:1})]),_:1}),o(e(q),null,{default:a(()=>[e(t).length<1?(f(),T(D,{key:0},[o(Te,{class:"pt-8",emoji:"\u{1F914}",text:"Serie nicht gefunden"}),W("div",we,[e(_)("contribution.add_collection")?(f(),V(e(B),{key:0,class:"text-center",onClick:C},{default:a(()=>[U("anlegen")]),_:1})):Y("",!0)])],64)):(f(!0),T(D,{key:1},se(e(t),u=>{var g;return f(),V(e(E),{key:(g=u.collection_id)!=null?g:"",button:!0,onClick:p=>b(u)},{default:a(()=>[o(e(re),{slot:"start"},{default:a(()=>{var p;return[o(Ee,{src:(p=u.cover)!=null?p:""},{default:a(()=>[o(e(ue),{class:"opacity-30",src:e(ye)},null,8,["src"])]),_:2},1032,["src"])]}),_:2},1024),o(e(G),null,{default:a(()=>[U(K(u.collection_name),1)]),_:2},1024)]),_:2},1032,["onClick"])}),128))]),_:1})]),_:1}))}});const Me={class:"p-4"},Se=M({__name:"MangaEditorForm",props:{currentTitle:null,currentSubtitle:null,currentDescription:null,isCurrentlyVisible:{type:Boolean},currentCollectionId:null,currentCollectionName:null,focus:null},emits:["update","empty"],setup(r,{emit:s}){var p,c,I,h,O;const n=r,t=ce({title:{value:n.currentTitle,isUpdate:n.focus==="title"},subtitle:{value:(p=n.currentSubtitle)!=null?p:"",isUpdate:n.focus==="subtitle"},description:{value:(c=n.currentDescription)!=null?c:"",isUpdate:n.focus==="description"},is_visible:{value:(I=n.isCurrentlyVisible)!=null?I:!0,isUpdate:!1},collection_id:{value:(h=n.currentCollectionId)!=null?h:null,isUpdate:!1},collection_name:{value:(O=n.currentCollectionName)!=null?O:null,isUpdate:!1}}),_=y(null),b=y(null),C=y(null),v=y(null),m=d=>{var l;(l=v.value)==null||l.$el.dismiss(d,"picked")},u=()=>{var d;(d=v.value)==null||d.$el.dismiss(void 0,"cleared")},g=d=>{var k,F;const l=d.detail.data,i=d.detail.role;i=="picked"?(t.collection_name.isUpdate=(l==null?void 0:l.collection_id)!=n.currentCollectionId,t.collection_id.value=(k=l==null?void 0:l.collection_id)!=null?k:null,t.collection_name.value=(F=l==null?void 0:l.collection_name)!=null?F:null):i!=="cleared"&&!t.collection_name.value?t.collection_name.isUpdate=!1:i=="cleared"&&n.currentCollectionId!==null?(t.collection_id.value="",t.collection_name.value="",t.collection_id.isUpdate=!0,t.collection_name.isUpdate=!0):n.currentCollectionId===null&&(t.collection_id.value=null,t.collection_name.value=null,t.collection_id.isUpdate=!1,t.collection_name.isUpdate=!1)};return P(()=>t.collection_id.isUpdate=t.collection_name.isUpdate),P(()=>{const d=l=>setTimeout(()=>l==null?void 0:l.$el.setFocus(),300);switch(n.focus){case"title":d(_.value);case"subtitle":d(b.value);case"description":d(C.value);default:return}}),de(t,d=>{const l=Object.entries(d).filter(i=>i[1].isUpdate).filter(i=>i[1].value!=null).map(i=>({[i[0]]:i[1].value})).reduce((i,k)=>$($({},i),k),{});Object.keys(l).length>0?s("update",{contribution:l}):s("empty")},{deep:!0}),(d,l)=>(f(),T(D,null,[W("div",Me,[o(e(pe),null,{default:a(()=>[U("Wenn ein bestimmtes Attribut aktualisiert werden soll, musst Du das H\xE4ckchen auf der rechten Seite aktivieren.")]),_:1})]),o(e(q),{lines:"full"},{default:a(()=>[o(e(E),null,{default:a(()=>[o(e(R),{ref_key:"titleInput",ref:_,placeholder:"Titel",modelValue:t.title.value,"onUpdate:modelValue":l[0]||(l[0]=i=>t.title.value=i),disabled:!t.title.isUpdate,onClick:l[1]||(l[1]=i=>t.title.isUpdate=!0)},null,8,["modelValue","disabled"]),o(e(x),{modelValue:t.title.isUpdate,"onUpdate:modelValue":l[2]||(l[2]=i=>t.title.isUpdate=i),slot:"end"},null,8,["modelValue"])]),_:1}),o(e(E),null,{default:a(()=>[o(e(R),{ref_key:"subtitleInput",ref:b,placeholder:"Untertitel",modelValue:t.subtitle.value,"onUpdate:modelValue":l[3]||(l[3]=i=>t.subtitle.value=i),disabled:!t.subtitle.isUpdate,onClick:l[4]||(l[4]=i=>t.subtitle.isUpdate=!0)},null,8,["modelValue","disabled"]),o(e(x),{modelValue:t.subtitle.isUpdate,"onUpdate:modelValue":l[5]||(l[5]=i=>t.subtitle.isUpdate=i),slot:"end"},null,8,["modelValue"])]),_:1}),o(e(E),{class:"item-with-button"},{default:a(()=>[o(e(B),{slot:"start",fill:"clear",size:"default",id:"open-collection-picker",class:me({"opacity-40":!t.collection_name.isUpdate})},{default:a(()=>[t.collection_name.value==""||t.collection_name.value==null?(f(),T(D,{key:0},[U("keine Serie")],64)):(f(),T(D,{key:1},[U(K(t.collection_name.value),1)],64))]),_:1},8,["class"]),o(e(x),{modelValue:t.collection_name.isUpdate,"onUpdate:modelValue":l[6]||(l[6]=i=>t.collection_name.isUpdate=i),slot:"end"},null,8,["modelValue"])]),_:1}),o(e(fe),{ref_key:"collectionPicker",ref:v,trigger:"open-collection-picker","initial-breakpoint":.25,breakpoints:[0,.25,.5,.75],onDidDismiss:g},{default:a(()=>[o(Pe,{onPick:m,onClear:u,onFocused:l[7]||(l[7]=i=>{var k;return(k=v.value)==null?void 0:k.$el.setCurrentBreakpoint(.75)})})]),_:1},8,["initial-breakpoint","breakpoints"]),o(e(E),null,{default:a(()=>[o(e(_e),{ref_key:"descriptionInput",ref:C,placeholder:"Beschreibung",modelValue:t.description.value,"onUpdate:modelValue":l[8]||(l[8]=i=>t.description.value=i),disabled:!t.description.isUpdate,"auto-grow":!0,onClick:l[9]||(l[9]=i=>t.description.isUpdate=!0)},null,8,["modelValue","disabled"]),o(e(x),{modelValue:t.description.isUpdate,"onUpdate:modelValue":l[10]||(l[10]=i=>t.description.isUpdate=i),slot:"end"},null,8,["modelValue"])]),_:1}),o(e(E),{lines:"none"},{default:a(()=>[o(e(G),null,{default:a(()=>[U("f\xFCr alle sichtbar")]),_:1}),o(e(be),{modelValue:t.is_visible.value,"onUpdate:modelValue":l[11]||(l[11]=i=>t.is_visible.value=i),slot:"end",onIonChange:l[12]||(l[12]=i=>t.is_visible.isUpdate=t.is_visible.value!==r.isCurrentlyVisible)},null,8,["modelValue"])]),_:1})]),_:1})],64))}});var he=$e(Se,[["__scopeId","data-v-c15d3bb8"]]);const{currentUser:Oe}=S(),{client:J}=ve(),Fe=async(r,s)=>{var _,b;const{error:n,data:t}=await J.rpc("contribution_event_creation",{_data:$({},s),_creator_id:(b=(_=Oe.value)==null?void 0:_.id)!=null?b:"",_gtin13:r}).single();if(n!=null||t<1)throw console.error(n!=null?n:"unknown Error"),Error();return t},Ae=async(r,s)=>{const{error:n}=await J.rpc("contributions_update",{_gtin13:r,_target_version:s});if(n!=null)throw console.error(n!=null?n:"unknown Error"),Error()},Ne=()=>({createContribution:Fe,updateContributions:Ae}),Je=M({__name:"MangaEditorPage",props:{gtin13:null,focus:null},setup(r){const s=r,{load:n,manga:t}=xe(),{createContribution:_,updateContributions:b}=Ne(),{back:C}=ge(),{hasPermission:v}=S(),m=le({id:"MangaEditor",initial:"Untouched",on:{EDITOR_UPDATE:{actions:"updateContribution"}},states:{Untouched:{on:{EDITOR_UPDATE:{target:"Editing",actions:"updateContribution"}}},Editing:{on:{EDITOR_EMPTY:{target:"Untouched"},SUBMIT:{target:"Contributing"}}},Contributing:{invoke:{id:"createContribution",src:"createContribution",onDone:{actions:["toastSuccess","leaveEditor"]},onError:{target:"Editing",actions:"toastError"}}}}},{actions:{updateContribution:Be({contribution:(p,c)=>c.type=="EDITOR_UPDATE"?c.contribution:p.contribution}),toastSuccess:()=>L({message:"Dein Beitrag ist in sp\xE4testens 5 Minuten online.",color:"success"}),toastError:()=>L({message:"Ups, da ist etwas schiefgegangen. Bitte versuch es sp\xE4ter erneut."}),leaveEditor:()=>C()},services:{createContribution:async p=>{const c=await _(s.gtin13,p.contribution);v("contributions.update")&&await b(s.gtin13,c)}}}),{state:u,send:g}=ne(m,{devTools:!1});return P(()=>n(s.gtin13)),(p,c)=>(f(),V(e(Ie),null,{default:a(()=>[o(e(j),{translucent:!0},{default:a(()=>[o(e(z),null,{default:a(()=>[o(e(w),{slot:"start"},{default:a(()=>[o(e(ke),{disabled:e(u).matches("Contributing"),"default-href":"/",text:""},null,8,["disabled"])]),_:1}),o(e(w),{slot:"end"},{default:a(()=>[o(e(B),{onClick:c[0]||(c[0]=I=>e(g)("SUBMIT")),disabled:!e(u).matches("Editing")},{default:a(()=>[o(e(H),{slot:"icon-only",src:e(ie)},null,8,["src"])]),_:1},8,["disabled"])]),_:1}),o(e(Ue),null,{default:a(()=>[U("Manga bearbeiten")]),_:1})]),_:1})]),_:1}),o(e(Q),{class:"ion-padding",fullscreen:!0},{default:a(()=>[o(e(Ce),{"is-open":e(u).matches("Contributing"),message:"Ich speichere Deinen Beitrag..."},null,8,["is-open"]),e(t)?(f(),V(he,{key:0,"current-title":e(t).title,"current-subtitle":e(t).subtitle,"current-description":e(t).description,"is-currently-visible":e(t).is_visible,"current-collection-id":e(t).collection_id,"current-collection-name":e(t).collection_name,focus:r.focus,onUpdate:c[1]||(c[1]=I=>e(g)("EDITOR_UPDATE",I)),onEmpty:c[2]||(c[2]=I=>e(g)("EDITOR_EMPTY"))},null,8,["current-title","current-subtitle","current-description","is-currently-visible","current-collection-id","current-collection-name","focus"])):Y("",!0)]),_:1})]),_:1}))}});export{Je as default};
