import{a as K,c as Q,u as X}from"./useMachine.094e07a5.js";import{t as G,i as Z}from"./index.2d43f867.js";import{d as M,r as y,p as P,o as _,c as V,w as i,a as n,u as t,z as R,s as N,t as ee,v as w,x,g as Y,A as j,H as T,K as D,j as H,D as U,E as L,J as te,a8 as E,aa as le,X as ne,C as z,R as W,h as q,ar as oe,q as B,ae as ie,as as se,at as O,au as $,y as ae,S as re,av as ue,aw as ce,P as de,n as pe,ao as me,a5 as fe,ax as _e,i as be}from"./index.f01522e6.js";import{_ as ve,a as ge}from"./WikiImg.5cde3b83.js";import{u as Ce}from"./collections.44b32de1.js";import{_ as Ue}from"./CenteredMessage.1d71ace6.js";import{d as ke}from"./dayjs.min.40569ce3.js";import{_ as Ie}from"./plugin-vue_export-helper.21dcd24c.js";import{u as Ee}from"./mangas.4d0a7d1d.js";import{a as A}from"./ui.2842e888.js";var ye=K;const Ve={class:"grid place-items-center pt-2"},Te=M({__name:"CollectionPicker",props:{suggestion:null},emits:["focused","pick","clear"],setup(d,{emit:u}){var I;const e=y((I=d.suggestion)!=null?I:""),{collections:m}=Ce(e),{hasPermission:b}=P(),k=g=>u("pick",g),v=()=>{u("pick",{collection_id:`MWC${ke().format("YYYYMMDDHHmmss")}`,collection_name:e.value.trim(),cover:null})};return(g,p)=>(_(),V(t(q),{class:"ion-padding"},{default:i(()=>[n(t(R),{class:"ion-no-border"},{default:i(()=>[n(t(N),null,{default:i(()=>[n(t(ee),{placeholder:"Serie suchen",modelValue:e.value,"onUpdate:modelValue":p[0]||(p[0]=r=>e.value=r),debounce:500,onClick:p[1]||(p[1]=r=>u("focused"))},null,8,["modelValue"]),n(t(w),{slot:"end"},{default:i(()=>[n(t(x),{onClick:p[2]||(p[2]=r=>u("clear"))},{default:i(()=>[n(t(Y),{slot:"icon-only",src:t(G)},null,8,["src"])]),_:1})]),_:1})]),_:1})]),_:1}),n(t(j),null,{default:i(()=>[t(m).length<1?(_(),T(D,{key:0},[n(Ue,{class:"pt-8",emoji:"\u{1F914}",text:"Serie nicht gefunden"}),H("div",Ve,[t(b)("contribution.add_collection")?(_(),V(t(x),{key:0,class:"text-center",disabled:e.value.length<2,onClick:v},{default:i(()=>[U("anlegen")]),_:1},8,["disabled"])):L("",!0)])],64)):(_(!0),T(D,{key:1},te(t(m),r=>{var a;return _(),V(t(E),{key:(a=r.collection_id)!=null?a:"",button:!0,onClick:f=>k(r)},{default:i(()=>[n(t(le),{slot:"start"},{default:i(()=>{var f;return[n(ve,{src:(f=r.cover)!=null?f:""},{default:i(()=>[n(t(ne),{class:"opacity-30",src:t(ge)},null,8,["src"])]),_:2},1032,["src"])]}),_:2},1024),n(t(z),null,{default:i(()=>[U(W(r.collection_name),1)]),_:2},1024)]),_:2},1032,["onClick"])}),128))]),_:1})]),_:1}))}});const De={class:"p-4"},$e=M({__name:"MangaEditorForm",props:{currentTitle:null,currentSubtitle:null,currentDescription:null,isCurrentlyVisible:{type:Boolean},currentCollectionId:null,currentCollectionName:null,focus:null},emits:["update","empty"],setup(d,{emit:u}){var r,a,f,S,h;const s=d,e=oe({title:{value:s.currentTitle,isUpdate:s.focus==="title"},subtitle:{value:(r=s.currentSubtitle)!=null?r:"",isUpdate:s.focus==="subtitle"},description:{value:(a=s.currentDescription)!=null?a:"",isUpdate:s.focus==="description"},is_visible:{value:(f=s.isCurrentlyVisible)!=null?f:!0,isUpdate:!1},collection_id:{value:(S=s.currentCollectionId)!=null?S:null,isUpdate:!1},collection_name:{value:(h=s.currentCollectionName)!=null?h:null,isUpdate:!1}}),m=y(null),b=y(null),k=y(null),v=y(null),I=c=>{var l;(l=v.value)==null||l.$el.dismiss(c,"picked")},g=()=>{var c;(c=v.value)==null||c.$el.dismiss(void 0,"cleared")},p=c=>{var C,F;const l=c.detail.data,o=c.detail.role;o=="picked"?(e.collection_name.isUpdate=(l==null?void 0:l.collection_id)!=s.currentCollectionId,e.collection_id.value=(C=l==null?void 0:l.collection_id)!=null?C:null,e.collection_name.value=(F=l==null?void 0:l.collection_name)!=null?F:null):o!=="cleared"&&!e.collection_name.value?e.collection_name.isUpdate=!1:o=="cleared"&&s.currentCollectionId!==null?(e.collection_id.value="",e.collection_name.value="",e.collection_id.isUpdate=!0,e.collection_name.isUpdate=!0):s.currentCollectionId===null&&(e.collection_id.value=null,e.collection_name.value=null,e.collection_id.isUpdate=!1,e.collection_name.isUpdate=!1)};return B(()=>e.collection_id.isUpdate=e.collection_name.isUpdate),B(()=>{const c=l=>setTimeout(()=>l==null?void 0:l.$el.setFocus(),300);switch(s.focus){case"title":c(m.value);case"subtitle":c(b.value);case"description":c(k.value);default:return}}),ie(e,c=>{const l=Object.entries(c).filter(o=>o[1].isUpdate).filter(o=>o[1].value!=null).map(o=>({[o[0]]:o[1].value})).reduce((o,C)=>({...o,...C}),{});Object.keys(l).length>0?u("update",{contribution:l}):u("empty")},{deep:!0}),(c,l)=>(_(),T(D,null,[H("div",De,[n(t(se),null,{default:i(()=>[U("Wenn ein bestimmtes Attribut aktualisiert werden soll, musst Du das H\xE4ckchen auf der rechten Seite aktivieren.")]),_:1})]),n(t(j),{lines:"full"},{default:i(()=>[n(t(E),null,{default:i(()=>[n(t(O),{ref_key:"titleInput",ref:m,placeholder:"Titel",modelValue:e.title.value,"onUpdate:modelValue":l[0]||(l[0]=o=>e.title.value=o),disabled:!e.title.isUpdate,onClick:l[1]||(l[1]=o=>e.title.isUpdate=!0)},null,8,["modelValue","disabled"]),n(t($),{modelValue:e.title.isUpdate,"onUpdate:modelValue":l[2]||(l[2]=o=>e.title.isUpdate=o),slot:"end"},null,8,["modelValue"])]),_:1}),n(t(E),null,{default:i(()=>[n(t(O),{ref_key:"subtitleInput",ref:b,placeholder:"Untertitel",modelValue:e.subtitle.value,"onUpdate:modelValue":l[3]||(l[3]=o=>e.subtitle.value=o),disabled:!e.subtitle.isUpdate,onClick:l[4]||(l[4]=o=>e.subtitle.isUpdate=!0)},null,8,["modelValue","disabled"]),n(t($),{modelValue:e.subtitle.isUpdate,"onUpdate:modelValue":l[5]||(l[5]=o=>e.subtitle.isUpdate=o),slot:"end"},null,8,["modelValue"])]),_:1}),n(t(E),{class:"item-with-button"},{default:i(()=>[n(t(x),{slot:"start",fill:"clear",size:"default",id:"open-collection-picker",class:ae({"opacity-40":!e.collection_name.isUpdate})},{default:i(()=>[e.collection_name.value==""||e.collection_name.value==null?(_(),T(D,{key:0},[U("keine Serie")],64)):(_(),T(D,{key:1},[U(W(e.collection_name.value),1)],64))]),_:1},8,["class"]),n(t($),{modelValue:e.collection_name.isUpdate,"onUpdate:modelValue":l[6]||(l[6]=o=>e.collection_name.isUpdate=o),slot:"end"},null,8,["modelValue"])]),_:1}),n(t(re),{ref_key:"collectionPicker",ref:v,trigger:"open-collection-picker","initial-breakpoint":.25,breakpoints:[0,.25,.5,.75],onDidDismiss:p},{default:i(()=>[n(Te,{suggestion:d.currentTitle.replace(/[0-9]/g,"").trim(),onPick:I,onClear:g,onFocused:l[7]||(l[7]=o=>{var C;return(C=v.value)==null?void 0:C.$el.setCurrentBreakpoint(.75)})},null,8,["suggestion"])]),_:1},8,["initial-breakpoint","breakpoints"]),n(t(E),null,{default:i(()=>[n(t(ue),{ref_key:"descriptionInput",ref:k,placeholder:"Beschreibung",modelValue:e.description.value,"onUpdate:modelValue":l[8]||(l[8]=o=>e.description.value=o),disabled:!e.description.isUpdate,"auto-grow":!0,onClick:l[9]||(l[9]=o=>e.description.isUpdate=!0)},null,8,["modelValue","disabled"]),n(t($),{modelValue:e.description.isUpdate,"onUpdate:modelValue":l[10]||(l[10]=o=>e.description.isUpdate=o),slot:"end"},null,8,["modelValue"])]),_:1}),n(t(E),{lines:"none"},{default:i(()=>[n(t(z),null,{default:i(()=>[U("f\xFCr alle sichtbar")]),_:1}),n(t(ce),{modelValue:e.is_visible.value,"onUpdate:modelValue":l[11]||(l[11]=o=>e.is_visible.value=o),slot:"end",onIonChange:l[12]||(l[12]=o=>e.is_visible.isUpdate=e.is_visible.value!==d.isCurrentlyVisible)},null,8,["modelValue"])]),_:1})]),_:1})],64))}});var xe=Ie($e,[["__scopeId","data-v-5e2ee75b"]]);const{currentUser:we}=P(),{client:J}=de(),Be=async(d,u)=>{var m,b;const{error:s,data:e}=await J.rpc("contribution_event_creation",{_data:{...u},_creator_id:(b=(m=we.value)==null?void 0:m.id)!=null?b:"",_gtin13:d}).single();if(s!=null||e<1)throw console.error(s!=null?s:"unknown Error"),Error();return e},Me=async(d,u)=>{const{error:s}=await J.rpc("contributions_update",{_gtin13:d,_target_version:u});if(s!=null)throw console.error(s!=null?s:"unknown Error"),Error()},Pe=()=>({createContribution:Be,updateContributions:Me}),Le=M({__name:"MangaEditorPage",props:{gtin13:null,focus:null},setup(d){const u=d,{load:s,manga:e}=Ee(),{createContribution:m,updateContributions:b}=Pe(),{back:k}=pe(),{hasPermission:v}=P(),I=Q({id:"MangaEditor",initial:"Untouched",on:{EDITOR_UPDATE:{actions:"updateContribution"}},states:{Untouched:{on:{EDITOR_UPDATE:{target:"Editing",actions:"updateContribution"}}},Editing:{on:{EDITOR_EMPTY:{target:"Untouched"},SUBMIT:{target:"Contributing"}}},Contributing:{invoke:{id:"createContribution",src:"createContribution",onDone:{actions:["toastSuccess","leaveEditor"]},onError:{target:"Editing",actions:"toastError"}}}}},{actions:{updateContribution:ye({contribution:(r,a)=>a.type=="EDITOR_UPDATE"?a.contribution:r.contribution}),toastSuccess:()=>A({message:"Dein Beitrag ist in sp\xE4testens 5 Minuten online.",color:"success"}),toastError:()=>A({message:"Ups, da ist etwas schiefgegangen. Bitte versuch es sp\xE4ter erneut."}),leaveEditor:()=>k()},services:{createContribution:async r=>{const a=await m(u.gtin13,r.contribution);v("contributions.update")&&await b(u.gtin13,a)}}}),{state:g,send:p}=X(I,{devTools:!1});return B(()=>s(u.gtin13)),(r,a)=>(_(),V(t(be),null,{default:i(()=>[n(t(R),{translucent:!0},{default:i(()=>[n(t(N),null,{default:i(()=>[n(t(w),{slot:"start"},{default:i(()=>[n(t(me),{disabled:t(g).matches("Contributing"),"default-href":"/",text:""},null,8,["disabled"])]),_:1}),n(t(w),{slot:"end"},{default:i(()=>[n(t(x),{onClick:a[0]||(a[0]=f=>t(p)("SUBMIT")),disabled:!t(g).matches("Editing")},{default:i(()=>[n(t(Y),{slot:"icon-only",src:t(Z)},null,8,["src"])]),_:1},8,["disabled"])]),_:1}),n(t(fe),null,{default:i(()=>[U("Manga bearbeiten")]),_:1})]),_:1})]),_:1}),n(t(q),{class:"ion-padding",fullscreen:!0},{default:i(()=>[n(t(_e),{"is-open":t(g).matches("Contributing"),message:"Ich speichere Deinen Beitrag..."},null,8,["is-open"]),t(e)?(_(),V(xe,{key:0,"current-title":t(e).title,"current-subtitle":t(e).subtitle,"current-description":t(e).description,"is-currently-visible":t(e).is_visible,"current-collection-id":t(e).collection_id,"current-collection-name":t(e).collection_name,focus:d.focus,onUpdate:a[1]||(a[1]=f=>t(p)("EDITOR_UPDATE",f)),onEmpty:a[2]||(a[2]=f=>t(p)("EDITOR_EMPTY"))},null,8,["current-title","current-subtitle","current-description","is-currently-visible","current-collection-id","current-collection-name","focus"])):L("",!0)]),_:1})]),_:1}))}});export{Le as default};
