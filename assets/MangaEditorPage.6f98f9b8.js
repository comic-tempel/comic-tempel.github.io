var X=Object.defineProperty;var A=Object.getOwnPropertySymbols;var Z=Object.prototype.hasOwnProperty,ee=Object.prototype.propertyIsEnumerable;var N=(r,a,o)=>a in r?X(r,a,{enumerable:!0,configurable:!0,writable:!0,value:o}):r[a]=o,$=(r,a)=>{for(var o in a||(a={}))Z.call(a,o)&&N(r,o,a[o]);if(A)for(var o of A(a))ee.call(a,o)&&N(r,o,a[o]);return r};import{a as te,c as le,u as ne}from"./useMachine.8f78a8ee.js";import{t as oe,i as ie}from"./index.2d43f867.js";import{d as P,z as y,y as h,o as b,c as V,w as s,a as n,u as t,G as H,B as L,C as se,D as B,E as w,g as j,H as z,k as T,N as D,l as W,L as C,P as q,O as ae,a9 as E,p as re,n as ue,K as G,t as K,h as Q,ar as ce,A as M,ae as de,as as pe,at as R,au as x,F as me,V as fe,av as be,aw as _e,q as ve,x as ge,ao as ke,a6 as Ce,ax as Ue,i as Ie}from"./index.5c7faab0.js";import{_ as Ee,a as ye}from"./WikiImg.ebf53eba.js";import{u as Ve}from"./collections.e267b755.js";import{_ as Te}from"./CenteredMessage.500336e3.js";import{d as De}from"./dayjs.min.21fbc072.js";import{_ as $e}from"./plugin-vue_export-helper.21dcd24c.js";import{u as xe}from"./mangas.c6d457b1.js";import{a as Y}from"./ui.2c6cebea.js";var we=te;const Be={class:"grid place-items-center pt-2"},Me=P({__name:"CollectionPicker",props:{suggestion:null},emits:["focused","pick","clear"],setup(r,{emit:a}){var I;const e=y((I=r.suggestion)!=null?I:""),{collections:m}=Ve(e),{hasPermission:_}=h(),U=g=>a("pick",g),v=()=>{a("pick",{collection_id:`MWC${De().format("YYYYMMDDHHmmss")}`,collection_name:e.value.trim(),cover:null})};return(g,p)=>(b(),V(t(Q),{class:"ion-padding"},{default:s(()=>[n(t(H),{class:"ion-no-border"},{default:s(()=>[n(t(L),null,{default:s(()=>[n(t(se),{placeholder:"Serie suchen",modelValue:e.value,"onUpdate:modelValue":p[0]||(p[0]=c=>e.value=c),debounce:500,onClick:p[1]||(p[1]=c=>a("focused"))},null,8,["modelValue"]),n(t(B),{slot:"end"},{default:s(()=>[n(t(w),{onClick:p[2]||(p[2]=c=>a("clear"))},{default:s(()=>[n(t(j),{slot:"icon-only",src:t(oe)},null,8,["src"])]),_:1})]),_:1})]),_:1})]),_:1}),n(t(z),null,{default:s(()=>[t(m).length<1?(b(),T(D,{key:0},[n(Te,{class:"pt-8",emoji:"\u{1F914}",text:"Serie nicht gefunden"}),W("div",Be,[t(_)("contribution.add_collection")?(b(),V(t(w),{key:0,class:"text-center",disabled:e.value.length<2,onClick:v},{default:s(()=>[C("anlegen")]),_:1},8,["disabled"])):q("",!0)])],64)):(b(!0),T(D,{key:1},ae(t(m),c=>{var u;return b(),V(t(E),{key:(u=c.collection_id)!=null?u:"",button:!0,onClick:f=>U(c)},{default:s(()=>[n(t(re),{slot:"start"},{default:s(()=>{var f;return[n(Ee,{src:(f=c.cover)!=null?f:""},{default:s(()=>[n(t(ue),{class:"opacity-30",src:t(ye)},null,8,["src"])]),_:2},1032,["src"])]}),_:2},1024),n(t(G),null,{default:s(()=>[C(K(c.collection_name),1)]),_:2},1024)]),_:2},1032,["onClick"])}),128))]),_:1})]),_:1}))}});const Pe={class:"p-4"},he=P({__name:"MangaEditorForm",props:{currentTitle:null,currentSubtitle:null,currentDescription:null,isCurrentlyVisible:{type:Boolean},currentCollectionId:null,currentCollectionName:null,focus:null},emits:["update","empty"],setup(r,{emit:a}){var c,u,f,S,F;const o=r,e=ce({title:{value:o.currentTitle,isUpdate:o.focus==="title"},subtitle:{value:(c=o.currentSubtitle)!=null?c:"",isUpdate:o.focus==="subtitle"},description:{value:(u=o.currentDescription)!=null?u:"",isUpdate:o.focus==="description"},is_visible:{value:(f=o.isCurrentlyVisible)!=null?f:!0,isUpdate:!1},collection_id:{value:(S=o.currentCollectionId)!=null?S:null,isUpdate:!1},collection_name:{value:(F=o.currentCollectionName)!=null?F:null,isUpdate:!1}}),m=y(null),_=y(null),U=y(null),v=y(null),I=d=>{var l;(l=v.value)==null||l.$el.dismiss(d,"picked")},g=()=>{var d;(d=v.value)==null||d.$el.dismiss(void 0,"cleared")},p=d=>{var k,O;const l=d.detail.data,i=d.detail.role;i=="picked"?(e.collection_name.isUpdate=(l==null?void 0:l.collection_id)!=o.currentCollectionId,e.collection_id.value=(k=l==null?void 0:l.collection_id)!=null?k:null,e.collection_name.value=(O=l==null?void 0:l.collection_name)!=null?O:null):i!=="cleared"&&!e.collection_name.value?e.collection_name.isUpdate=!1:i=="cleared"&&o.currentCollectionId!==null?(e.collection_id.value="",e.collection_name.value="",e.collection_id.isUpdate=!0,e.collection_name.isUpdate=!0):o.currentCollectionId===null&&(e.collection_id.value=null,e.collection_name.value=null,e.collection_id.isUpdate=!1,e.collection_name.isUpdate=!1)};return M(()=>e.collection_id.isUpdate=e.collection_name.isUpdate),M(()=>{const d=l=>setTimeout(()=>l==null?void 0:l.$el.setFocus(),300);switch(o.focus){case"title":d(m.value);case"subtitle":d(_.value);case"description":d(U.value);default:return}}),de(e,d=>{const l=Object.entries(d).filter(i=>i[1].isUpdate).filter(i=>i[1].value!=null).map(i=>({[i[0]]:i[1].value})).reduce((i,k)=>$($({},i),k),{});Object.keys(l).length>0?a("update",{contribution:l}):a("empty")},{deep:!0}),(d,l)=>(b(),T(D,null,[W("div",Pe,[n(t(pe),null,{default:s(()=>[C("Wenn ein bestimmtes Attribut aktualisiert werden soll, musst Du das H\xE4ckchen auf der rechten Seite aktivieren.")]),_:1})]),n(t(z),{lines:"full"},{default:s(()=>[n(t(E),null,{default:s(()=>[n(t(R),{ref_key:"titleInput",ref:m,placeholder:"Titel",modelValue:e.title.value,"onUpdate:modelValue":l[0]||(l[0]=i=>e.title.value=i),disabled:!e.title.isUpdate,onClick:l[1]||(l[1]=i=>e.title.isUpdate=!0)},null,8,["modelValue","disabled"]),n(t(x),{modelValue:e.title.isUpdate,"onUpdate:modelValue":l[2]||(l[2]=i=>e.title.isUpdate=i),slot:"end"},null,8,["modelValue"])]),_:1}),n(t(E),null,{default:s(()=>[n(t(R),{ref_key:"subtitleInput",ref:_,placeholder:"Untertitel",modelValue:e.subtitle.value,"onUpdate:modelValue":l[3]||(l[3]=i=>e.subtitle.value=i),disabled:!e.subtitle.isUpdate,onClick:l[4]||(l[4]=i=>e.subtitle.isUpdate=!0)},null,8,["modelValue","disabled"]),n(t(x),{modelValue:e.subtitle.isUpdate,"onUpdate:modelValue":l[5]||(l[5]=i=>e.subtitle.isUpdate=i),slot:"end"},null,8,["modelValue"])]),_:1}),n(t(E),{class:"item-with-button"},{default:s(()=>[n(t(w),{slot:"start",fill:"clear",size:"default",id:"open-collection-picker",class:me({"opacity-40":!e.collection_name.isUpdate})},{default:s(()=>[e.collection_name.value==""||e.collection_name.value==null?(b(),T(D,{key:0},[C("keine Serie")],64)):(b(),T(D,{key:1},[C(K(e.collection_name.value),1)],64))]),_:1},8,["class"]),n(t(x),{modelValue:e.collection_name.isUpdate,"onUpdate:modelValue":l[6]||(l[6]=i=>e.collection_name.isUpdate=i),slot:"end"},null,8,["modelValue"])]),_:1}),n(t(fe),{ref_key:"collectionPicker",ref:v,trigger:"open-collection-picker","initial-breakpoint":.25,breakpoints:[0,.25,.5,.75],onDidDismiss:p},{default:s(()=>[n(Me,{suggestion:r.currentTitle.replace(/[0-9]/g,"").trim(),onPick:I,onClear:g,onFocused:l[7]||(l[7]=i=>{var k;return(k=v.value)==null?void 0:k.$el.setCurrentBreakpoint(.75)})},null,8,["suggestion"])]),_:1},8,["initial-breakpoint","breakpoints"]),n(t(E),null,{default:s(()=>[n(t(be),{ref_key:"descriptionInput",ref:U,placeholder:"Beschreibung",modelValue:e.description.value,"onUpdate:modelValue":l[8]||(l[8]=i=>e.description.value=i),disabled:!e.description.isUpdate,"auto-grow":!0,onClick:l[9]||(l[9]=i=>e.description.isUpdate=!0)},null,8,["modelValue","disabled"]),n(t(x),{modelValue:e.description.isUpdate,"onUpdate:modelValue":l[10]||(l[10]=i=>e.description.isUpdate=i),slot:"end"},null,8,["modelValue"])]),_:1}),n(t(E),{lines:"none"},{default:s(()=>[n(t(G),null,{default:s(()=>[C("f\xFCr alle sichtbar")]),_:1}),n(t(_e),{modelValue:e.is_visible.value,"onUpdate:modelValue":l[11]||(l[11]=i=>e.is_visible.value=i),slot:"end",onIonChange:l[12]||(l[12]=i=>e.is_visible.isUpdate=e.is_visible.value!==r.isCurrentlyVisible)},null,8,["modelValue"])]),_:1})]),_:1})],64))}});var Se=$e(he,[["__scopeId","data-v-5e2ee75b"]]);const{currentUser:Fe}=h(),{client:J}=ve(),Oe=async(r,a)=>{var m,_;const{error:o,data:e}=await J.rpc("contribution_event_creation",{_data:$({},a),_creator_id:(_=(m=Fe.value)==null?void 0:m.id)!=null?_:"",_gtin13:r}).single();if(o!=null||e<1)throw console.error(o!=null?o:"unknown Error"),Error();return e},Ae=async(r,a)=>{const{error:o}=await J.rpc("contributions_update",{_gtin13:r,_target_version:a});if(o!=null)throw console.error(o!=null?o:"unknown Error"),Error()},Ne=()=>({createContribution:Oe,updateContributions:Ae}),Je=P({__name:"MangaEditorPage",props:{gtin13:null,focus:null},setup(r){const a=r,{load:o,manga:e}=xe(),{createContribution:m,updateContributions:_}=Ne(),{back:U}=ge(),{hasPermission:v}=h(),I=le({id:"MangaEditor",initial:"Untouched",on:{EDITOR_UPDATE:{actions:"updateContribution"}},states:{Untouched:{on:{EDITOR_UPDATE:{target:"Editing",actions:"updateContribution"}}},Editing:{on:{EDITOR_EMPTY:{target:"Untouched"},SUBMIT:{target:"Contributing"}}},Contributing:{invoke:{id:"createContribution",src:"createContribution",onDone:{actions:["toastSuccess","leaveEditor"]},onError:{target:"Editing",actions:"toastError"}}}}},{actions:{updateContribution:we({contribution:(c,u)=>u.type=="EDITOR_UPDATE"?u.contribution:c.contribution}),toastSuccess:()=>Y({message:"Dein Beitrag ist in sp\xE4testens 5 Minuten online.",color:"success"}),toastError:()=>Y({message:"Ups, da ist etwas schiefgegangen. Bitte versuch es sp\xE4ter erneut."}),leaveEditor:()=>U()},services:{createContribution:async c=>{const u=await m(a.gtin13,c.contribution);v("contributions.update")&&await _(a.gtin13,u)}}}),{state:g,send:p}=ne(I,{devTools:!1});return M(()=>o(a.gtin13)),(c,u)=>(b(),V(t(Ie),null,{default:s(()=>[n(t(H),{translucent:!0},{default:s(()=>[n(t(L),null,{default:s(()=>[n(t(B),{slot:"start"},{default:s(()=>[n(t(ke),{disabled:t(g).matches("Contributing"),"default-href":"/",text:""},null,8,["disabled"])]),_:1}),n(t(B),{slot:"end"},{default:s(()=>[n(t(w),{onClick:u[0]||(u[0]=f=>t(p)("SUBMIT")),disabled:!t(g).matches("Editing")},{default:s(()=>[n(t(j),{slot:"icon-only",src:t(ie)},null,8,["src"])]),_:1},8,["disabled"])]),_:1}),n(t(Ce),null,{default:s(()=>[C("Manga bearbeiten")]),_:1})]),_:1})]),_:1}),n(t(Q),{class:"ion-padding",fullscreen:!0},{default:s(()=>[n(t(Ue),{"is-open":t(g).matches("Contributing"),message:"Ich speichere Deinen Beitrag..."},null,8,["is-open"]),t(e)?(b(),V(Se,{key:0,"current-title":t(e).title,"current-subtitle":t(e).subtitle,"current-description":t(e).description,"is-currently-visible":t(e).is_visible,"current-collection-id":t(e).collection_id,"current-collection-name":t(e).collection_name,focus:r.focus,onUpdate:u[1]||(u[1]=f=>t(p)("EDITOR_UPDATE",f)),onEmpty:u[2]||(u[2]=f=>t(p)("EDITOR_EMPTY"))},null,8,["current-title","current-subtitle","current-description","is-currently-visible","current-collection-id","current-collection-name","focus"])):q("",!0)]),_:1})]),_:1}))}});export{Je as default};
